<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicaci√≥n Firebase y DOM Corregida</title>
    <!-- Carga Tailwind CSS para un estilo r√°pido y limpio -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="container-card w-full max-w-lg bg-white p-8 rounded-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Estado de la Aplicaci√≥n</h1>
        
        <!-- Elemento para mostrar el estado de Firebase y Auth -->
        <div id="status-display" class="mb-6 p-4 rounded-lg text-sm transition duration-300 bg-gray-100 border border-gray-200">
            <p id="firebase-status" class="font-medium text-gray-700">Inicializando Firebase...</p>
            <p id="auth-status" class="text-gray-600">Estado de autenticaci√≥n: Esperando...</p>
            <p id="user-id" class="text-xs mt-2 break-all text-gray-500 hidden"></p>
        </div>

        <!-- Bot√≥n que causaba el Error 3, ahora manejado en DOMContentLoaded -->
        <button id="share-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
            Abrir Modal de Compartir (Simulaci√≥n)
        </button>

        <!-- Placeholder para el Modal de Compartir (simulado) -->
        <div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" aria-modal="true" role="dialog">
            <div class="bg-white p-6 rounded-lg w-full max-w-sm">
                <h3 class="text-xl font-semibold mb-4">Modal de Compartir</h3>
                <p>¬°El DOM estaba listo y el evento se adjunt√≥ correctamente!</p>
                <button id="close-modal-button" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globales del entorno Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app;
        let auth;
        let db;

        /**
         * Inicializa Firebase (Soluciona Error 1 y prepara para Error 2).
         */
        function initializeFirebase() {
            const statusEl = document.getElementById('firebase-status');
            
            try {
                // 1. Manejo de la configuraci√≥n (Soluci√≥n al Error 1)
                const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(firebaseConfigString);

                // Comprobar si falta projectId (causa ra√≠z del Error 1)
                if (!firebaseConfig.projectId) {
                    throw new Error('"projectId" no proporcionado. Revisar __firebase_config.');
                }

                // Inicializar la aplicaci√≥n
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // Inicializaci√≥n exitosa del servicio Auth (Soluciona Error 2)

                statusEl.textContent = '‚úÖ Firebase inicializado correctamente.';
                return true;

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                statusEl.textContent = `‚ùå Error al inicializar Firebase: ${error.message}`;
                return false;
            }
        }

        /**
         * Configura la autenticaci√≥n (usa el objeto 'auth' ya inicializado).
         */
        async function setupAuthentication() {
            const statusEl = document.getElementById('auth-status');
            const userIdEl = document.getElementById('user-id');
            
            if (!auth) {
                statusEl.textContent = 'üî¥ Auth no disponible. Inicializaci√≥n de Firebase fallida.';
                return;
            }

            try {
                // Autenticar al usuario
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Configurar el oyente de estado de autenticaci√≥n (que antes fallaba en el Error 2)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        statusEl.textContent = '‚úÖ Autenticado con √©xito.';
                        userIdEl.textContent = `ID de Usuario (UID): ${user.uid}`;
                        userIdEl.classList.remove('hidden');
                        console.log("Usuario autenticado. UID:", user.uid);
                    } else {
                        statusEl.textContent = '‚ö†Ô∏è Autenticado an√≥nimamente (o no loggeado).';
                        userIdEl.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Error en la autenticaci√≥n:", error);
                statusEl.textContent = `‚ùå Error de autenticaci√≥n: ${error.message}`;
            }
        }

        /**
         * Maneja los eventos del DOM (Soluciona Error 3).
         */
        function setupDOMElements() {
            // El c√≥digo aqu√≠ se ejecuta S√ìLO despu√©s de que el DOM est√° listo
            const shareButton = document.getElementById('share-button');
            const shareModal = document.getElementById('share-modal');
            const closeModalButton = document.getElementById('close-modal-button');

            // 1. Comprobamos la existencia de los elementos (aunque en este caso siempre existir√°n)
            // (Soluci√≥n al Error 3: 'addEventListener' on 'null')
            if (shareButton && shareModal && closeModalButton) {
                
                shareButton.addEventListener('click', () => {
                    shareModal.classList.remove('hidden');
                    console.log("Modal de compartir abierto.");
                });

                closeModalButton.addEventListener('click', () => {
                    shareModal.classList.add('hidden');
                    console.log("Modal de compartir cerrado.");
                });
            } else {
                console.warn("Faltan elementos DOM: shareButton o shareModal no encontrados.");
            }
        }


        // -----------------------------------------------------------
        // Punto de Entrada de la Aplicaci√≥n
        // -----------------------------------------------------------

        // 1. Inicializa Firebase (debe ser lo primero)
        const isFirebaseInitialized = initializeFirebase();

        // 2. Si Firebase es exitoso, configura la autenticaci√≥n
        if (isFirebaseInitialized) {
            setupAuthentication();
        }

        // 3. Espera a que el DOM est√© completamente cargado para interactuar con los elementos
        document.addEventListener('DOMContentLoaded', setupDOMElements);

    </script>
</body>
</html>